name: Build Android

on: workflow_dispatch: push: branches: [ main ]

jobs: build-android: runs-on: ubuntu-latest

steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Setup Haxe
    uses: krdlab/setup-haxe@v1
    with:
      haxe-version: 4.2.5

  - name: Setup Java
    uses: actions/setup-java@v4
    with:
      distribution: temurin
      java-version: 17

  - name: Setup Android SDK
    uses: android-actions/setup-android@v3

  - name: Setup haxelib
    run: |
      mkdir -p ~/haxelib
      haxelib setup ~/haxelib

  - name: Install libraries
    run: |
      haxelib install lime --quiet
      haxelib install openfl --quiet
      haxelib install hxcpp --quiet
      haxelib install flixel --quiet
      haxelib install flixel-addons --quiet
      haxelib install flixel-ui --quiet

  - name: Decode keystore
    run: |
      echo "$KEYSTORE_BASE64" | base64 --decode > kareshi.keystore
    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

  - name: Lime setup Android
    run: haxelib run lime setup android

  - name: Build Android APK (release signed)
    run: |
      haxelib run lime build android -release \
        -D KEYSTORE=kareshi.keystore \
        -D KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }} \
        -D KEY_ALIAS=${{ secrets.KEY_ALIAS }} \
        -D KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}

  - name: Build Android AAB (Play Store)
    run: |
      haxelib run lime build android -release -aab \
        -D KEYSTORE=kareshi.keystore \
        -D KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }} \
        -D KEY_ALIAS=${{ secrets.KEY_ALIAS }} \
        -D KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}

  - name: List export folder
    run: find export -type f || true

  - name: Find APK
    run: |
      APK=$(find export -type f -name "*.apk" | head -n 1)
      if [ -z "$APK" ]; then
        echo "APK not found" >&2
        exit 1
      fi
      echo "APK_PATH=$APK" >> $GITHUB_ENV

  - name: Find AAB
    run: |
      AAB=$(find export -type f -name "*.aab" | head -n 1)
      if [ -z "$AAB" ]; then
        echo "AAB not found" >&2
        exit 1
      fi
      echo "AAB_PATH=$AAB" >> $GITHUB_ENV

  - name: Upload APK
    uses: actions/upload-artifact@v4
    with:
      name: KareshiProject-APK
      path: ${{ env.APK_PATH }}

  - name: Upload AAB
    uses: actions/upload-artifact@v4
    with:
      name: KareshiProject-AAB
      path: ${{ env.AAB_PATH }}